function UUIDjs(){}function Handler(){}UUIDjs.maxFromBits=function(bits){return Math.pow(2,bits)},UUIDjs.limitUI04=UUIDjs.maxFromBits(4),UUIDjs.limitUI06=UUIDjs.maxFromBits(6),UUIDjs.limitUI08=UUIDjs.maxFromBits(8),UUIDjs.limitUI12=UUIDjs.maxFromBits(12),UUIDjs.limitUI14=UUIDjs.maxFromBits(14),UUIDjs.limitUI16=UUIDjs.maxFromBits(16),UUIDjs.limitUI32=UUIDjs.maxFromBits(32),UUIDjs.limitUI40=UUIDjs.maxFromBits(40),UUIDjs.limitUI48=UUIDjs.maxFromBits(48),UUIDjs.randomUI04=function(){return Math.round(Math.random()*UUIDjs.limitUI04)},UUIDjs.randomUI06=function(){return Math.round(Math.random()*UUIDjs.limitUI06)},UUIDjs.randomUI08=function(){return Math.round(Math.random()*UUIDjs.limitUI08)},UUIDjs.randomUI12=function(){return Math.round(Math.random()*UUIDjs.limitUI12)},UUIDjs.randomUI14=function(){return Math.round(Math.random()*UUIDjs.limitUI14)},UUIDjs.randomUI16=function(){return Math.round(Math.random()*UUIDjs.limitUI16)},UUIDjs.randomUI32=function(){return Math.round(Math.random()*UUIDjs.limitUI32)},UUIDjs.randomUI40=function(){return(0|Math.random()*(1<<30))+(0|1024*Math.random())*(1<<30)},UUIDjs.randomUI48=function(){return(0|Math.random()*(1<<30))+(0|Math.random()*(1<<18))*(1<<30)},UUIDjs.paddedString=function(string,length,z){string=String(string),z=z?z:"0";var i=length-string.length;for(i;i>0;i>>>=1,z+=z)1&i&&(string=z+string);return string},UUIDjs.prototype.fromParts=function(timeLow,timeMid,timeHiAndVersion,clockSeqHiAndReserved,clockSeqLow,node){return this.version=timeHiAndVersion>>12&15,this.hex=UUIDjs.paddedString(timeLow.toString(16),8)+"-"+UUIDjs.paddedString(timeMid.toString(16),4)+"-"+UUIDjs.paddedString(timeHiAndVersion.toString(16),4)+"-"+UUIDjs.paddedString(clockSeqHiAndReserved.toString(16),2)+UUIDjs.paddedString(clockSeqLow.toString(16),2)+"-"+UUIDjs.paddedString(node.toString(16),12),this},UUIDjs.prototype.toString=function(){return this.hex},UUIDjs.prototype.toURN=function(){return"urn:uuid:"+this.hex},UUIDjs.prototype.toBytes=function(){var parts=this.hex.split("-"),ints=[],intPos=0,i=0;for(i;i<parts.length;i++){var j=0;for(j;j<parts[i].length;j+=2)ints[intPos++]=parseInt(parts[i].substr(j,2),16)}return ints},UUIDjs.prototype.equals=function(uuid){return uuid instanceof UUID?this.hex!==uuid.hex?!1:!0:!1},UUIDjs.getTimeFieldValues=function(time){var ts=time-Date.UTC(1582,9,15),hm=ts/4294967296*1e4&268435455;return{low:1e4*(268435455&ts)%4294967296,mid:65535&hm,hi:hm>>>16,timestamp:ts}},UUIDjs._create4=function(){return(new UUIDjs).fromParts(UUIDjs.randomUI32(),UUIDjs.randomUI16(),16384|UUIDjs.randomUI12(),128|UUIDjs.randomUI06(),UUIDjs.randomUI08(),UUIDjs.randomUI48())},UUIDjs._create1=function(){var now=(new Date).getTime(),sequence=UUIDjs.randomUI14(),node=1099511627776*(1|UUIDjs.randomUI08())+UUIDjs.randomUI40(),tick=UUIDjs.randomUI04(),timestamp=0,timestampRatio=.25;now!==timestamp?(timestamp>now&&sequence++,timestamp=now,tick=UUIDjs.randomUI04()):Math.random()<timestampRatio&&9984>tick?tick+=1+UUIDjs.randomUI04():sequence++;var tf=UUIDjs.getTimeFieldValues(timestamp),tl=tf.low+tick,thav=4095&tf.hi|4096;sequence&=16383;var cshar=sequence>>>8|128,csl=255&sequence;return(new UUIDjs).fromParts(tl,tf.mid,thav,cshar,csl,node)},UUIDjs.create=function(version){return version=version||4,this["_create"+version]()},UUIDjs.fromTime=function(time,last){last=last?last:!1;var tf=UUIDjs.getTimeFieldValues(time),tl=tf.low,thav=4095&tf.hi|4096;return last===!1?(new UUIDjs).fromParts(tl,tf.mid,thav,0,0,0):(new UUIDjs).fromParts(tl,tf.mid,thav,128|UUIDjs.limitUI06,UUIDjs.limitUI08-1,UUIDjs.limitUI48-1)},UUIDjs.firstFromTime=function(time){return UUIDjs.fromTime(time,!1)},UUIDjs.lastFromTime=function(time){return UUIDjs.fromTime(time,!0)},UUIDjs.fromURN=function(strId){var r,p=/^(?:urn:uuid:|\{)?([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{2})([0-9a-f]{2})-([0-9a-f]{12})(?:\})?$/i;return r===p.exec(strId)?(new UUIDjs).fromParts(parseInt(r[1],16),parseInt(r[2],16),parseInt(r[3],16),parseInt(r[4],16),parseInt(r[5],16),parseInt(r[6],16)):null},UUIDjs.fromBytes=function(ints){var str="",pos=0,parts=[4,2,2,2,6],i=0;if(ints.length<5)return null;for(i;i<parts.length;i++){var j=0;for(j;j<parts[i];j++){var octet=ints[pos++].toString(16);1===octet.length&&(octet="0"+octet),str+=octet}6!==parts[i]&&(str+="-")}return UUIDjs.fromURN(str)},UUIDjs.fromBinary=function(binary){var ints=[],i=0;for(i;i<binary.length;i++)if(ints[i]=binary.charCodeAt(i),ints[i]>255||ints[i]<0)throw new Error("Unexpected byte in binary data.");return UUIDjs.fromBytes(ints)},"undefined"==typeof Paho&&(Paho={}),Paho.MQTT=function(global){function decodeMessage(input,pos){var startingPos=pos,first=input[pos],type=first>>4,messageInfo=first&=15;pos+=1;var digit,remLength=0,multiplier=1;do{if(pos==input.length)return[null,startingPos];digit=input[pos++],remLength+=(127&digit)*multiplier,multiplier*=128}while(0!=(128&digit));var endPos=pos+remLength;if(endPos>input.length)return[null,startingPos];var wireMessage=new WireMessage(type);switch(type){case MESSAGE_TYPE.CONNACK:var connectAcknowledgeFlags=input[pos++];1&connectAcknowledgeFlags&&(wireMessage.sessionPresent=!0),wireMessage.returnCode=input[pos++];break;case MESSAGE_TYPE.PUBLISH:var qos=messageInfo>>1&3,len=readUint16(input,pos);pos+=2;var topicName=parseUTF8(input,pos,len);pos+=len,qos>0&&(wireMessage.messageIdentifier=readUint16(input,pos),pos+=2);var message=new Paho.MQTT.Message(input.subarray(pos,endPos));1==(1&messageInfo)&&(message.retained=!0),8==(8&messageInfo)&&(message.duplicate=!0),message.qos=qos,message.destinationName=topicName,wireMessage.payloadMessage=message;break;case MESSAGE_TYPE.PUBACK:case MESSAGE_TYPE.PUBREC:case MESSAGE_TYPE.PUBREL:case MESSAGE_TYPE.PUBCOMP:case MESSAGE_TYPE.UNSUBACK:wireMessage.messageIdentifier=readUint16(input,pos);break;case MESSAGE_TYPE.SUBACK:wireMessage.messageIdentifier=readUint16(input,pos),pos+=2,wireMessage.returnCode=input.subarray(pos,endPos)}return[wireMessage,endPos]}function writeUint16(input,buffer,offset){return buffer[offset++]=input>>8,buffer[offset++]=input%256,offset}function writeString(input,utf8Length,buffer,offset){return offset=writeUint16(utf8Length,buffer,offset),stringToUTF8(input,buffer,offset),offset+utf8Length}function readUint16(buffer,offset){return 256*buffer[offset]+buffer[offset+1]}function encodeMBI(number){var output=new Array(1),numBytes=0;do{var digit=number%128;number>>=7,number>0&&(digit|=128),output[numBytes++]=digit}while(number>0&&4>numBytes);return output}function UTF8Length(input){for(var output=0,i=0;i<input.length;i++){var charCode=input.charCodeAt(i);charCode>2047?(charCode>=55296&&56319>=charCode&&(i++,output++),output+=3):charCode>127?output+=2:output++}return output}function stringToUTF8(input,output,start){for(var pos=start,i=0;i<input.length;i++){var charCode=input.charCodeAt(i);if(charCode>=55296&&56319>=charCode){var lowCharCode=input.charCodeAt(++i);if(isNaN(lowCharCode))throw new Error(format(ERROR.MALFORMED_UNICODE,[charCode,lowCharCode]));charCode=(charCode-55296<<10)+(lowCharCode-56320)+65536}127>=charCode?output[pos++]=charCode:2047>=charCode?(output[pos++]=charCode>>6&31|192,output[pos++]=63&charCode|128):65535>=charCode?(output[pos++]=charCode>>12&15|224,output[pos++]=charCode>>6&63|128,output[pos++]=63&charCode|128):(output[pos++]=charCode>>18&7|240,output[pos++]=charCode>>12&63|128,output[pos++]=charCode>>6&63|128,output[pos++]=63&charCode|128)}return output}function parseUTF8(input,offset,length){for(var utf16,output="",pos=offset;offset+length>pos;){var byte1=input[pos++];if(128>byte1)utf16=byte1;else{var byte2=input[pos++]-128;if(0>byte2)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),""]));if(224>byte1)utf16=64*(byte1-192)+byte2;else{var byte3=input[pos++]-128;if(0>byte3)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16)]));if(240>byte1)utf16=4096*(byte1-224)+64*byte2+byte3;else{var byte4=input[pos++]-128;if(0>byte4)throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16),byte4.toString(16)]));if(!(248>byte1))throw new Error(format(ERROR.MALFORMED_UTF,[byte1.toString(16),byte2.toString(16),byte3.toString(16),byte4.toString(16)]));utf16=262144*(byte1-240)+4096*byte2+64*byte3+byte4}}}utf16>65535&&(utf16-=65536,output+=String.fromCharCode(55296+(utf16>>10)),utf16=56320+(1023&utf16)),output+=String.fromCharCode(utf16)}return output}var version="@VERSION@",MESSAGE_TYPE={CONNECT:1,CONNACK:2,PUBLISH:3,PUBACK:4,PUBREC:5,PUBREL:6,PUBCOMP:7,SUBSCRIBE:8,SUBACK:9,UNSUBSCRIBE:10,UNSUBACK:11,PINGREQ:12,PINGRESP:13,DISCONNECT:14},validate=function(obj,keys){for(var key in obj)if(obj.hasOwnProperty(key)){if(!keys.hasOwnProperty(key)){var errorStr="Unknown property, "+key+". Valid properties are:";for(var key in keys)keys.hasOwnProperty(key)&&(errorStr=errorStr+" "+key);throw new Error(errorStr)}if(typeof obj[key]!==keys[key])throw new Error(format(ERROR.INVALID_TYPE,[typeof obj[key],key]))}},scope=function(f,scope){return function(){return f.apply(scope,arguments)}},ERROR={OK:{code:0,text:"AMQJSC0000I OK."},CONNECT_TIMEOUT:{code:1,text:"AMQJSC0001E Connect timed out."},SUBSCRIBE_TIMEOUT:{code:2,text:"AMQJS0002E Subscribe timed out."},UNSUBSCRIBE_TIMEOUT:{code:3,text:"AMQJS0003E Unsubscribe timed out."},PING_TIMEOUT:{code:4,text:"AMQJS0004E Ping timed out."},INTERNAL_ERROR:{code:5,text:"AMQJS0005E Internal error. Error Message: {0}, Stack trace: {1}"},CONNACK_RETURNCODE:{code:6,text:"AMQJS0006E Bad Connack return code:{0} {1}."},SOCKET_ERROR:{code:7,text:"AMQJS0007E Socket error:{0}."},SOCKET_CLOSE:{code:8,text:"AMQJS0008I Socket closed."},MALFORMED_UTF:{code:9,text:"AMQJS0009E Malformed UTF data:{0} {1} {2}."},UNSUPPORTED:{code:10,text:"AMQJS0010E {0} is not supported by this browser."},INVALID_STATE:{code:11,text:"AMQJS0011E Invalid state {0}."},INVALID_TYPE:{code:12,text:"AMQJS0012E Invalid type {0} for {1}."},INVALID_ARGUMENT:{code:13,text:"AMQJS0013E Invalid argument {0} for {1}."},UNSUPPORTED_OPERATION:{code:14,text:"AMQJS0014E Unsupported operation."},INVALID_STORED_DATA:{code:15,text:"AMQJS0015E Invalid data in local storage key={0} value={1}."},INVALID_MQTT_MESSAGE_TYPE:{code:16,text:"AMQJS0016E Invalid MQTT message type {0}."},MALFORMED_UNICODE:{code:17,text:"AMQJS0017E Malformed Unicode string:{0} {1}."}},CONNACK_RC={0:"Connection Accepted",1:"Connection Refused: unacceptable protocol version",2:"Connection Refused: identifier rejected",3:"Connection Refused: server unavailable",4:"Connection Refused: bad user name or password",5:"Connection Refused: not authorized"},format=function(error,substitutions){var text=error.text;if(substitutions)for(var field,start,i=0;i<substitutions.length;i++)if(field="{"+i+"}",start=text.indexOf(field),start>0){var part1=text.substring(0,start),part2=text.substring(start+field.length);text=part1+substitutions[i]+part2}return text},MqttProtoIdentifierv3=[0,6,77,81,73,115,100,112,3],MqttProtoIdentifierv4=[0,4,77,81,84,84,4],WireMessage=function(type,options){this.type=type;for(var name in options)options.hasOwnProperty(name)&&(this[name]=options[name])};WireMessage.prototype.encode=function(){var first=(15&this.type)<<4,remLength=0,topicStrLength=new Array,destinationNameLength=0;switch(void 0!=this.messageIdentifier&&(remLength+=2),this.type){case MESSAGE_TYPE.CONNECT:switch(this.mqttVersion){case 3:remLength+=MqttProtoIdentifierv3.length+3;break;case 4:remLength+=MqttProtoIdentifierv4.length+3}if(remLength+=UTF8Length(this.clientId)+2,void 0!=this.willMessage){remLength+=UTF8Length(this.willMessage.destinationName)+2;var willMessagePayloadBytes=this.willMessage.payloadBytes;willMessagePayloadBytes instanceof Uint8Array||(willMessagePayloadBytes=new Uint8Array(payloadBytes)),remLength+=willMessagePayloadBytes.byteLength+2}void 0!=this.userName&&(remLength+=UTF8Length(this.userName)+2),void 0!=this.password&&(remLength+=UTF8Length(this.password)+2);break;case MESSAGE_TYPE.SUBSCRIBE:first|=2;for(var i=0;i<this.topics.length;i++)topicStrLength[i]=UTF8Length(this.topics[i]),remLength+=topicStrLength[i]+2;remLength+=this.requestedQos.length;break;case MESSAGE_TYPE.UNSUBSCRIBE:first|=2;for(var i=0;i<this.topics.length;i++)topicStrLength[i]=UTF8Length(this.topics[i]),remLength+=topicStrLength[i]+2;break;case MESSAGE_TYPE.PUBREL:first|=2;break;case MESSAGE_TYPE.PUBLISH:this.payloadMessage.duplicate&&(first|=8),first=first|=this.payloadMessage.qos<<1,this.payloadMessage.retained&&(first|=1),destinationNameLength=UTF8Length(this.payloadMessage.destinationName),remLength+=destinationNameLength+2;var payloadBytes=this.payloadMessage.payloadBytes;remLength+=payloadBytes.byteLength,payloadBytes instanceof ArrayBuffer?payloadBytes=new Uint8Array(payloadBytes):payloadBytes instanceof Uint8Array||(payloadBytes=new Uint8Array(payloadBytes.buffer));break;case MESSAGE_TYPE.DISCONNECT:}var mbi=encodeMBI(remLength),pos=mbi.length+1,buffer=new ArrayBuffer(remLength+pos),byteStream=new Uint8Array(buffer);if(byteStream[0]=first,byteStream.set(mbi,1),this.type==MESSAGE_TYPE.PUBLISH)pos=writeString(this.payloadMessage.destinationName,destinationNameLength,byteStream,pos);else if(this.type==MESSAGE_TYPE.CONNECT){switch(this.mqttVersion){case 3:byteStream.set(MqttProtoIdentifierv3,pos),pos+=MqttProtoIdentifierv3.length;break;case 4:byteStream.set(MqttProtoIdentifierv4,pos),pos+=MqttProtoIdentifierv4.length}var connectFlags=0;this.cleanSession&&(connectFlags=2),void 0!=this.willMessage&&(connectFlags|=4,connectFlags|=this.willMessage.qos<<3,this.willMessage.retained&&(connectFlags|=32)),void 0!=this.userName&&(connectFlags|=128),void 0!=this.password&&(connectFlags|=64),byteStream[pos++]=connectFlags,pos=writeUint16(this.keepAliveInterval,byteStream,pos)}switch(void 0!=this.messageIdentifier&&(pos=writeUint16(this.messageIdentifier,byteStream,pos)),this.type){case MESSAGE_TYPE.CONNECT:pos=writeString(this.clientId,UTF8Length(this.clientId),byteStream,pos),void 0!=this.willMessage&&(pos=writeString(this.willMessage.destinationName,UTF8Length(this.willMessage.destinationName),byteStream,pos),pos=writeUint16(willMessagePayloadBytes.byteLength,byteStream,pos),byteStream.set(willMessagePayloadBytes,pos),pos+=willMessagePayloadBytes.byteLength),void 0!=this.userName&&(pos=writeString(this.userName,UTF8Length(this.userName),byteStream,pos)),void 0!=this.password&&(pos=writeString(this.password,UTF8Length(this.password),byteStream,pos));break;case MESSAGE_TYPE.PUBLISH:byteStream.set(payloadBytes,pos);break;case MESSAGE_TYPE.SUBSCRIBE:for(var i=0;i<this.topics.length;i++)pos=writeString(this.topics[i],topicStrLength[i],byteStream,pos),byteStream[pos++]=this.requestedQos[i];break;case MESSAGE_TYPE.UNSUBSCRIBE:for(var i=0;i<this.topics.length;i++)pos=writeString(this.topics[i],topicStrLength[i],byteStream,pos)}return buffer};var Pinger=function(client,window,keepAliveInterval){this._client=client,this._window=window,this._keepAliveInterval=1e3*keepAliveInterval,this.isReset=!1;var pingReq=new WireMessage(MESSAGE_TYPE.PINGREQ).encode(),doTimeout=function(pinger){return function(){return doPing.apply(pinger)}},doPing=function(){this.isReset?(this.isReset=!1,this._client._trace("Pinger.doPing","send PINGREQ"),this._client.socket.send(pingReq),this.timeout=this._window.setTimeout(doTimeout(this),this._keepAliveInterval)):(this._client._trace("Pinger.doPing","Timed out"),this._client._disconnected(ERROR.PING_TIMEOUT.code,format(ERROR.PING_TIMEOUT)))};this.reset=function(){this.isReset=!0,this._window.clearTimeout(this.timeout),this._keepAliveInterval>0&&(this.timeout=setTimeout(doTimeout(this),this._keepAliveInterval))},this.cancel=function(){this._window.clearTimeout(this.timeout)}},Timeout=function(client,window,timeoutSeconds,action,args){this._window=window,timeoutSeconds||(timeoutSeconds=30);var doTimeout=function(action,client,args){return function(){return action.apply(client,args)}};this.timeout=setTimeout(doTimeout(action,client,args),1e3*timeoutSeconds),this.cancel=function(){this._window.clearTimeout(this.timeout)}},ClientImpl=function(uri,host,port,path,clientId){if(!("WebSocket"in global&&null!==global.WebSocket))throw new Error(format(ERROR.UNSUPPORTED,["WebSocket"]));if(!("localStorage"in global&&null!==global.localStorage))throw new Error(format(ERROR.UNSUPPORTED,["localStorage"]));if(!("ArrayBuffer"in global&&null!==global.ArrayBuffer))throw new Error(format(ERROR.UNSUPPORTED,["ArrayBuffer"]));this._trace("Paho.MQTT.Client",uri,host,port,path,clientId),this.host=host,this.port=port,this.path=path,this.uri=uri,this.clientId=clientId,this._localKey=host+":"+port+("/mqtt"!=path?":"+path:"")+":"+clientId+":",this._msg_queue=[],this._sentMessages={},this._receivedMessages={},this._notify_msg_sent={},this._message_identifier=1,this._sequence=0;for(var key in localStorage)(0==key.indexOf("Sent:"+this._localKey)||0==key.indexOf("Received:"+this._localKey))&&this.restore(key)};ClientImpl.prototype.host,ClientImpl.prototype.port,ClientImpl.prototype.path,ClientImpl.prototype.uri,ClientImpl.prototype.clientId,ClientImpl.prototype.socket,ClientImpl.prototype.connected=!1,ClientImpl.prototype.maxMessageIdentifier=65536,ClientImpl.prototype.connectOptions,ClientImpl.prototype.hostIndex,ClientImpl.prototype.onConnectionLost,ClientImpl.prototype.onMessageDelivered,ClientImpl.prototype.onMessageArrived,ClientImpl.prototype.traceFunction,ClientImpl.prototype._msg_queue=null,ClientImpl.prototype._connectTimeout,ClientImpl.prototype.sendPinger=null,ClientImpl.prototype.receivePinger=null,ClientImpl.prototype.receiveBuffer=null,ClientImpl.prototype._traceBuffer=null,ClientImpl.prototype._MAX_TRACE_ENTRIES=100,ClientImpl.prototype.connect=function(connectOptions){var connectOptionsMasked=this._traceMask(connectOptions,"password");if(this._trace("Client.connect",connectOptionsMasked,this.socket,this.connected),this.connected)throw new Error(format(ERROR.INVALID_STATE,["already connected"]));if(this.socket)throw new Error(format(ERROR.INVALID_STATE,["already connected"]));this.connectOptions=connectOptions,connectOptions.uris?(this.hostIndex=0,this._doConnect(connectOptions.uris[0])):this._doConnect(this.uri)},ClientImpl.prototype.subscribe=function(filter,subscribeOptions){if(this._trace("Client.subscribe",filter,subscribeOptions),!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));var wireMessage=new WireMessage(MESSAGE_TYPE.SUBSCRIBE);wireMessage.topics=[filter],void 0!=subscribeOptions.qos?wireMessage.requestedQos=[subscribeOptions.qos]:wireMessage.requestedQos=[0],subscribeOptions.onSuccess&&(wireMessage.onSuccess=function(grantedQos){subscribeOptions.onSuccess({invocationContext:subscribeOptions.invocationContext,grantedQos:grantedQos})}),subscribeOptions.onFailure&&(wireMessage.onFailure=function(errorCode){subscribeOptions.onFailure({invocationContext:subscribeOptions.invocationContext,errorCode:errorCode})}),subscribeOptions.timeout&&(wireMessage.timeOut=new Timeout(this,window,subscribeOptions.timeout,subscribeOptions.onFailure,[{invocationContext:subscribeOptions.invocationContext,errorCode:ERROR.SUBSCRIBE_TIMEOUT.code,errorMessage:format(ERROR.SUBSCRIBE_TIMEOUT)}])),this._requires_ack(wireMessage),this._schedule_message(wireMessage)},ClientImpl.prototype.unsubscribe=function(filter,unsubscribeOptions){if(this._trace("Client.unsubscribe",filter,unsubscribeOptions),!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));var wireMessage=new WireMessage(MESSAGE_TYPE.UNSUBSCRIBE);wireMessage.topics=[filter],unsubscribeOptions.onSuccess&&(wireMessage.callback=function(){unsubscribeOptions.onSuccess({invocationContext:unsubscribeOptions.invocationContext})}),unsubscribeOptions.timeout&&(wireMessage.timeOut=new Timeout(this,window,unsubscribeOptions.timeout,unsubscribeOptions.onFailure,[{invocationContext:unsubscribeOptions.invocationContext,errorCode:ERROR.UNSUBSCRIBE_TIMEOUT.code,errorMessage:format(ERROR.UNSUBSCRIBE_TIMEOUT)}])),this._requires_ack(wireMessage),this._schedule_message(wireMessage)},ClientImpl.prototype.send=function(message){if(this._trace("Client.send",message),!this.connected)throw new Error(format(ERROR.INVALID_STATE,["not connected"]));wireMessage=new WireMessage(MESSAGE_TYPE.PUBLISH),wireMessage.payloadMessage=message,message.qos>0?this._requires_ack(wireMessage):this.onMessageDelivered&&(this._notify_msg_sent[wireMessage]=this.onMessageDelivered(wireMessage.payloadMessage)),this._schedule_message(wireMessage)},ClientImpl.prototype.disconnect=function(){if(this._trace("Client.disconnect"),!this.socket)throw new Error(format(ERROR.INVALID_STATE,["not connecting or connected"]));wireMessage=new WireMessage(MESSAGE_TYPE.DISCONNECT),this._notify_msg_sent[wireMessage]=scope(this._disconnected,this),this._schedule_message(wireMessage)},ClientImpl.prototype.getTraceLog=function(){if(null!==this._traceBuffer){this._trace("Client.getTraceLog",new Date),this._trace("Client.getTraceLog in flight messages",this._sentMessages.length);for(var key in this._sentMessages)this._trace("_sentMessages ",key,this._sentMessages[key]);for(var key in this._receivedMessages)this._trace("_receivedMessages ",key,this._receivedMessages[key]);return this._traceBuffer}},ClientImpl.prototype.startTrace=function(){null===this._traceBuffer&&(this._traceBuffer=[]),this._trace("Client.startTrace",new Date,version)},ClientImpl.prototype.stopTrace=function(){delete this._traceBuffer},ClientImpl.prototype._doConnect=function(wsurl){if(this.connectOptions.useSSL){var uriParts=wsurl.split(":");uriParts[0]="wss",wsurl=uriParts.join(":")}this.connected=!1,this.connectOptions.mqttVersion<4?this.socket=new WebSocket(wsurl,[]):this.socket=new WebSocket(wsurl,["mqtt"]),this.socket.binaryType="arraybuffer",this.socket.onopen=scope(this._on_socket_open,this),this.socket.onmessage=scope(this._on_socket_message,this),this.socket.onerror=scope(this._on_socket_error,this),this.socket.onclose=scope(this._on_socket_close,this),this.sendPinger=new Pinger(this,window,this.connectOptions.keepAliveInterval),this.receivePinger=new Pinger(this,window,this.connectOptions.keepAliveInterval),this._connectTimeout=new Timeout(this,window,this.connectOptions.timeout,this._disconnected,[ERROR.CONNECT_TIMEOUT.code,format(ERROR.CONNECT_TIMEOUT)])},ClientImpl.prototype._schedule_message=function(message){this._msg_queue.push(message),this.connected&&this._process_queue()},ClientImpl.prototype.store=function(prefix,wireMessage){var storedMessage={type:wireMessage.type,messageIdentifier:wireMessage.messageIdentifier,version:1};switch(wireMessage.type){case MESSAGE_TYPE.PUBLISH:wireMessage.pubRecReceived&&(storedMessage.pubRecReceived=!0),storedMessage.payloadMessage={};for(var hex="",messageBytes=wireMessage.payloadMessage.payloadBytes,i=0;i<messageBytes.length;i++)messageBytes[i]<=15?hex=hex+"0"+messageBytes[i].toString(16):hex+=messageBytes[i].toString(16);storedMessage.payloadMessage.payloadHex=hex,storedMessage.payloadMessage.qos=wireMessage.payloadMessage.qos,storedMessage.payloadMessage.destinationName=wireMessage.payloadMessage.destinationName,wireMessage.payloadMessage.duplicate&&(storedMessage.payloadMessage.duplicate=!0),wireMessage.payloadMessage.retained&&(storedMessage.payloadMessage.retained=!0),0==prefix.indexOf("Sent:")&&(void 0===wireMessage.sequence&&(wireMessage.sequence=++this._sequence),storedMessage.sequence=wireMessage.sequence);break;default:throw Error(format(ERROR.INVALID_STORED_DATA,[key,storedMessage]))}localStorage.setItem(prefix+this._localKey+wireMessage.messageIdentifier,JSON.stringify(storedMessage))},ClientImpl.prototype.restore=function(key){var value=localStorage.getItem(key),storedMessage=JSON.parse(value),wireMessage=new WireMessage(storedMessage.type,storedMessage);switch(storedMessage.type){case MESSAGE_TYPE.PUBLISH:for(var hex=storedMessage.payloadMessage.payloadHex,buffer=new ArrayBuffer(hex.length/2),byteStream=new Uint8Array(buffer),i=0;hex.length>=2;){var x=parseInt(hex.substring(0,2),16);hex=hex.substring(2,hex.length),byteStream[i++]=x}var payloadMessage=new Paho.MQTT.Message(byteStream);payloadMessage.qos=storedMessage.payloadMessage.qos,payloadMessage.destinationName=storedMessage.payloadMessage.destinationName,storedMessage.payloadMessage.duplicate&&(payloadMessage.duplicate=!0),storedMessage.payloadMessage.retained&&(payloadMessage.retained=!0),wireMessage.payloadMessage=payloadMessage;break;default:throw Error(format(ERROR.INVALID_STORED_DATA,[key,value]))}0==key.indexOf("Sent:"+this._localKey)?(wireMessage.payloadMessage.duplicate=!0,this._sentMessages[wireMessage.messageIdentifier]=wireMessage):0==key.indexOf("Received:"+this._localKey)&&(this._receivedMessages[wireMessage.messageIdentifier]=wireMessage)},ClientImpl.prototype._process_queue=function(){for(var message=null,fifo=this._msg_queue.reverse();message=fifo.pop();)this._socket_send(message),this._notify_msg_sent[message]&&(this._notify_msg_sent[message](),delete this._notify_msg_sent[message])},ClientImpl.prototype._requires_ack=function(wireMessage){var messageCount=Object.keys(this._sentMessages).length;if(messageCount>this.maxMessageIdentifier)throw Error("Too many messages:"+messageCount);for(;void 0!==this._sentMessages[this._message_identifier];)this._message_identifier++;wireMessage.messageIdentifier=this._message_identifier,this._sentMessages[wireMessage.messageIdentifier]=wireMessage,wireMessage.type===MESSAGE_TYPE.PUBLISH&&this.store("Sent:",wireMessage),this._message_identifier===this.maxMessageIdentifier&&(this._message_identifier=1)},ClientImpl.prototype._on_socket_open=function(){var wireMessage=new WireMessage(MESSAGE_TYPE.CONNECT,this.connectOptions);wireMessage.clientId=this.clientId,this._socket_send(wireMessage)},ClientImpl.prototype._on_socket_message=function(event){this._trace("Client._on_socket_message",event.data),this.receivePinger.reset();for(var messages=this._deframeMessages(event.data),i=0;i<messages.length;i+=1)this._handleMessage(messages[i])},ClientImpl.prototype._deframeMessages=function(data){var byteArray=new Uint8Array(data);if(this.receiveBuffer){var newData=new Uint8Array(this.receiveBuffer.length+byteArray.length);newData.set(this.receiveBuffer),newData.set(byteArray,this.receiveBuffer.length),byteArray=newData,delete this.receiveBuffer}try{for(var offset=0,messages=[];offset<byteArray.length;){var result=decodeMessage(byteArray,offset),wireMessage=result[0];if(offset=result[1],null===wireMessage)break;messages.push(wireMessage)}offset<byteArray.length&&(this.receiveBuffer=byteArray.subarray(offset))}catch(error){return void this._disconnected(ERROR.INTERNAL_ERROR.code,format(ERROR.INTERNAL_ERROR,[error.message,error.stack.toString()]))}return messages},ClientImpl.prototype._handleMessage=function(wireMessage){this._trace("Client._handleMessage",wireMessage);try{switch(wireMessage.type){case MESSAGE_TYPE.CONNACK:if(this._connectTimeout.cancel(),this.connectOptions.cleanSession){for(var key in this._sentMessages){var sentMessage=this._sentMessages[key];localStorage.removeItem("Sent:"+this._localKey+sentMessage.messageIdentifier)}this._sentMessages={};for(var key in this._receivedMessages){var receivedMessage=this._receivedMessages[key];localStorage.removeItem("Received:"+this._localKey+receivedMessage.messageIdentifier)}this._receivedMessages={}}if(0!==wireMessage.returnCode){this._disconnected(ERROR.CONNACK_RETURNCODE.code,format(ERROR.CONNACK_RETURNCODE,[wireMessage.returnCode,CONNACK_RC[wireMessage.returnCode]]));break}this.connected=!0,this.connectOptions.uris&&(this.hostIndex=this.connectOptions.uris.length);var sequencedMessages=new Array;for(var msgId in this._sentMessages)this._sentMessages.hasOwnProperty(msgId)&&sequencedMessages.push(this._sentMessages[msgId]);for(var sequencedMessages=sequencedMessages.sort(function(a,b){return a.sequence-b.sequence}),i=0,len=sequencedMessages.length;len>i;i++){var sentMessage=sequencedMessages[i];if(sentMessage.type==MESSAGE_TYPE.PUBLISH&&sentMessage.pubRecReceived){var pubRelMessage=new WireMessage(MESSAGE_TYPE.PUBREL,{messageIdentifier:sentMessage.messageIdentifier});this._schedule_message(pubRelMessage)}else this._schedule_message(sentMessage)}this.connectOptions.onSuccess&&this.connectOptions.onSuccess({invocationContext:this.connectOptions.invocationContext}),this._process_queue();break;case MESSAGE_TYPE.PUBLISH:this._receivePublish(wireMessage);break;case MESSAGE_TYPE.PUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];sentMessage&&(delete this._sentMessages[wireMessage.messageIdentifier],localStorage.removeItem("Sent:"+this._localKey+wireMessage.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(sentMessage.payloadMessage));break;case MESSAGE_TYPE.PUBREC:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];if(sentMessage){sentMessage.pubRecReceived=!0;var pubRelMessage=new WireMessage(MESSAGE_TYPE.PUBREL,{messageIdentifier:wireMessage.messageIdentifier});this.store("Sent:",sentMessage),this._schedule_message(pubRelMessage)}break;case MESSAGE_TYPE.PUBREL:var receivedMessage=this._receivedMessages[wireMessage.messageIdentifier];localStorage.removeItem("Received:"+this._localKey+wireMessage.messageIdentifier),receivedMessage&&(this._receiveMessage(receivedMessage),delete this._receivedMessages[wireMessage.messageIdentifier]);var pubCompMessage=new WireMessage(MESSAGE_TYPE.PUBCOMP,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubCompMessage);break;case MESSAGE_TYPE.PUBCOMP:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];delete this._sentMessages[wireMessage.messageIdentifier],localStorage.removeItem("Sent:"+this._localKey+wireMessage.messageIdentifier),this.onMessageDelivered&&this.onMessageDelivered(sentMessage.payloadMessage);break;case MESSAGE_TYPE.SUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];sentMessage&&(sentMessage.timeOut&&sentMessage.timeOut.cancel(),128===wireMessage.returnCode[0]?sentMessage.onFailure&&sentMessage.onFailure(wireMessage.returnCode):sentMessage.onSuccess&&sentMessage.onSuccess(wireMessage.returnCode),delete this._sentMessages[wireMessage.messageIdentifier]);break;case MESSAGE_TYPE.UNSUBACK:var sentMessage=this._sentMessages[wireMessage.messageIdentifier];sentMessage&&(sentMessage.timeOut&&sentMessage.timeOut.cancel(),sentMessage.callback&&sentMessage.callback(),delete this._sentMessages[wireMessage.messageIdentifier]);break;case MESSAGE_TYPE.PINGRESP:this.sendPinger.reset();break;case MESSAGE_TYPE.DISCONNECT:this._disconnected(ERROR.INVALID_MQTT_MESSAGE_TYPE.code,format(ERROR.INVALID_MQTT_MESSAGE_TYPE,[wireMessage.type]));break;default:this._disconnected(ERROR.INVALID_MQTT_MESSAGE_TYPE.code,format(ERROR.INVALID_MQTT_MESSAGE_TYPE,[wireMessage.type]))}}catch(error){return void this._disconnected(ERROR.INTERNAL_ERROR.code,format(ERROR.INTERNAL_ERROR,[error.message,error.stack.toString()]))}},ClientImpl.prototype._on_socket_error=function(error){this._disconnected(ERROR.SOCKET_ERROR.code,format(ERROR.SOCKET_ERROR,[error.data]))},ClientImpl.prototype._on_socket_close=function(){this._disconnected(ERROR.SOCKET_CLOSE.code,format(ERROR.SOCKET_CLOSE))},ClientImpl.prototype._socket_send=function(wireMessage){if(1==wireMessage.type){var wireMessageMasked=this._traceMask(wireMessage,"password");this._trace("Client._socket_send",wireMessageMasked)}else this._trace("Client._socket_send",wireMessage);this.socket.send(wireMessage.encode()),this.sendPinger.reset()},ClientImpl.prototype._receivePublish=function(wireMessage){switch(wireMessage.payloadMessage.qos){case"undefined":case 0:this._receiveMessage(wireMessage);break;case 1:var pubAckMessage=new WireMessage(MESSAGE_TYPE.PUBACK,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubAckMessage),this._receiveMessage(wireMessage);break;case 2:this._receivedMessages[wireMessage.messageIdentifier]=wireMessage,this.store("Received:",wireMessage);
var pubRecMessage=new WireMessage(MESSAGE_TYPE.PUBREC,{messageIdentifier:wireMessage.messageIdentifier});this._schedule_message(pubRecMessage);break;default:throw Error("Invaild qos="+wireMmessage.payloadMessage.qos)}},ClientImpl.prototype._receiveMessage=function(wireMessage){this.onMessageArrived&&this.onMessageArrived(wireMessage.payloadMessage)},ClientImpl.prototype._disconnected=function(errorCode,errorText){this._trace("Client._disconnected",errorCode,errorText),this.sendPinger.cancel(),this.receivePinger.cancel(),this._connectTimeout&&this._connectTimeout.cancel(),this._msg_queue=[],this._notify_msg_sent={},this.socket&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,1===this.socket.readyState&&this.socket.close(),delete this.socket),this.connectOptions.uris&&this.hostIndex<this.connectOptions.uris.length-1?(this.hostIndex++,this._doConnect(this.connectOptions.uris[this.hostIndex])):(void 0===errorCode&&(errorCode=ERROR.OK.code,errorText=format(ERROR.OK)),this.connected?(this.connected=!1,this.onConnectionLost&&this.onConnectionLost({errorCode:errorCode,errorMessage:errorText})):4===this.connectOptions.mqttVersion&&this.connectOptions.mqttVersionExplicit===!1?(this._trace("Failed to connect V4, dropping back to V3"),this.connectOptions.mqttVersion=3,this.connectOptions.uris?(this.hostIndex=0,this._doConnect(this.connectOptions.uris[0])):this._doConnect(this.uri)):this.connectOptions.onFailure&&this.connectOptions.onFailure({invocationContext:this.connectOptions.invocationContext,errorCode:errorCode,errorMessage:errorText}))},ClientImpl.prototype._trace=function(){if(this.traceFunction){for(var i in arguments)"undefined"!=typeof arguments[i]&&(arguments[i]=JSON.stringify(arguments[i]));var record=Array.prototype.slice.call(arguments).join("");this.traceFunction({severity:"Debug",message:record})}if(null!==this._traceBuffer)for(var i=0,max=arguments.length;max>i;i++)this._traceBuffer.length==this._MAX_TRACE_ENTRIES&&this._traceBuffer.shift(),this._traceBuffer.push(0===i?arguments[i]:"undefined"==typeof arguments[i]?arguments[i]:"  "+JSON.stringify(arguments[i]))},ClientImpl.prototype._traceMask=function(traceObject,masked){var traceObjectMasked={};for(var attr in traceObject)traceObject.hasOwnProperty(attr)&&(attr==masked?traceObjectMasked[attr]="******":traceObjectMasked[attr]=traceObject[attr]);return traceObjectMasked};var Client=function(host,port,path,clientId){var uri;if("string"!=typeof host)throw new Error(format(ERROR.INVALID_TYPE,[typeof host,"host"]));if(2==arguments.length){clientId=port,uri=host;var match=uri.match(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/);if(!match)throw new Error(format(ERROR.INVALID_ARGUMENT,[host,"host"]));host=match[4]||match[2],port=parseInt(match[7]),path=match[8]}else{if(3==arguments.length&&(clientId=path,path="/mqtt"),"number"!=typeof port||0>port)throw new Error(format(ERROR.INVALID_TYPE,[typeof port,"port"]));if("string"!=typeof path)throw new Error(format(ERROR.INVALID_TYPE,[typeof path,"path"]));var ipv6AddSBracket=-1!=host.indexOf(":")&&"["!=host.slice(0,1)&&"]"!=host.slice(-1);uri="ws://"+(ipv6AddSBracket?"["+host+"]":host)+":"+port+path}for(var clientIdLength=0,i=0;i<clientId.length;i++){var charCode=clientId.charCodeAt(i);charCode>=55296&&56319>=charCode&&i++,clientIdLength++}if("string"!=typeof clientId||clientIdLength>65535)throw new Error(format(ERROR.INVALID_ARGUMENT,[clientId,"clientId"]));var client=new ClientImpl(uri,host,port,path,clientId);this._getHost=function(){return host},this._setHost=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getPort=function(){return port},this._setPort=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getPath=function(){return path},this._setPath=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getURI=function(){return uri},this._setURI=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getClientId=function(){return client.clientId},this._setClientId=function(){throw new Error(format(ERROR.UNSUPPORTED_OPERATION))},this._getOnConnectionLost=function(){return client.onConnectionLost},this._setOnConnectionLost=function(newOnConnectionLost){if("function"!=typeof newOnConnectionLost)throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnConnectionLost,"onConnectionLost"]));client.onConnectionLost=newOnConnectionLost},this._getOnMessageDelivered=function(){return client.onMessageDelivered},this._setOnMessageDelivered=function(newOnMessageDelivered){if("function"!=typeof newOnMessageDelivered)throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnMessageDelivered,"onMessageDelivered"]));client.onMessageDelivered=newOnMessageDelivered},this._getOnMessageArrived=function(){return client.onMessageArrived},this._setOnMessageArrived=function(newOnMessageArrived){if("function"!=typeof newOnMessageArrived)throw new Error(format(ERROR.INVALID_TYPE,[typeof newOnMessageArrived,"onMessageArrived"]));client.onMessageArrived=newOnMessageArrived},this._getTrace=function(){return client.traceFunction},this._setTrace=function(trace){if("function"!=typeof trace)throw new Error(format(ERROR.INVALID_TYPE,[typeof trace,"onTrace"]));client.traceFunction=trace},this.connect=function(connectOptions){if(connectOptions=connectOptions||{},validate(connectOptions,{timeout:"number",userName:"string",password:"string",willMessage:"object",keepAliveInterval:"number",cleanSession:"boolean",useSSL:"boolean",invocationContext:"object",onSuccess:"function",onFailure:"function",hosts:"object",ports:"object",mqttVersion:"number"}),void 0===connectOptions.keepAliveInterval&&(connectOptions.keepAliveInterval=60),connectOptions.mqttVersion>4||connectOptions.mqttVersion<3)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.mqttVersion,"connectOptions.mqttVersion"]));if(void 0===connectOptions.mqttVersion?(connectOptions.mqttVersionExplicit=!1,connectOptions.mqttVersion=4):connectOptions.mqttVersionExplicit=!0,void 0===connectOptions.password&&void 0!==connectOptions.userName)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.password,"connectOptions.password"]));if(connectOptions.willMessage){if(!(connectOptions.willMessage instanceof Message))throw new Error(format(ERROR.INVALID_TYPE,[connectOptions.willMessage,"connectOptions.willMessage"]));if(connectOptions.willMessage.stringPayload,"undefined"==typeof connectOptions.willMessage.destinationName)throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.willMessage.destinationName,"connectOptions.willMessage.destinationName"]))}if("undefined"==typeof connectOptions.cleanSession&&(connectOptions.cleanSession=!0),connectOptions.hosts){if(!(connectOptions.hosts instanceof Array))throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts,"connectOptions.hosts"]));if(connectOptions.hosts.length<1)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts,"connectOptions.hosts"]));for(var usingURIs=!1,i=0;i<connectOptions.hosts.length;i++){if("string"!=typeof connectOptions.hosts[i])throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]));if(/^(wss?):\/\/((\[(.+)\])|([^\/]+?))(:(\d+))?(\/.*)$/.test(connectOptions.hosts[i])){if(0==i)usingURIs=!0;else if(!usingURIs)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]))}else if(usingURIs)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.hosts[i],"connectOptions.hosts["+i+"]"]))}if(usingURIs)connectOptions.uris=connectOptions.hosts;else{if(!connectOptions.ports)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));if(!(connectOptions.ports instanceof Array))throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));if(connectOptions.hosts.length!=connectOptions.ports.length)throw new Error(format(ERROR.INVALID_ARGUMENT,[connectOptions.ports,"connectOptions.ports"]));connectOptions.uris=[];for(var i=0;i<connectOptions.hosts.length;i++){if("number"!=typeof connectOptions.ports[i]||connectOptions.ports[i]<0)throw new Error(format(ERROR.INVALID_TYPE,[typeof connectOptions.ports[i],"connectOptions.ports["+i+"]"]));var host=connectOptions.hosts[i],port=connectOptions.ports[i],ipv6=-1!=host.indexOf(":");uri="ws://"+(ipv6?"["+host+"]":host)+":"+port+path,connectOptions.uris.push(uri)}}}client.connect(connectOptions)},this.subscribe=function(filter,subscribeOptions){if("string"!=typeof filter)throw new Error("Invalid argument:"+filter);if(subscribeOptions=subscribeOptions||{},validate(subscribeOptions,{qos:"number",invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),subscribeOptions.timeout&&!subscribeOptions.onFailure)throw new Error("subscribeOptions.timeout specified with no onFailure callback.");if("undefined"!=typeof subscribeOptions.qos&&0!==subscribeOptions.qos&&1!==subscribeOptions.qos&&2!==subscribeOptions.qos)throw new Error(format(ERROR.INVALID_ARGUMENT,[subscribeOptions.qos,"subscribeOptions.qos"]));client.subscribe(filter,subscribeOptions)},this.unsubscribe=function(filter,unsubscribeOptions){if("string"!=typeof filter)throw new Error("Invalid argument:"+filter);if(unsubscribeOptions=unsubscribeOptions||{},validate(unsubscribeOptions,{invocationContext:"object",onSuccess:"function",onFailure:"function",timeout:"number"}),unsubscribeOptions.timeout&&!unsubscribeOptions.onFailure)throw new Error("unsubscribeOptions.timeout specified with no onFailure callback.");client.unsubscribe(filter,unsubscribeOptions)},this.send=function(topic,payload,qos,retained){var message;if(0==arguments.length)throw new Error("Invalid argument.length");if(1==arguments.length){if(!(topic instanceof Message)&&"string"!=typeof topic)throw new Error("Invalid argument:"+typeof topic);if(message=topic,"undefined"==typeof message.destinationName)throw new Error(format(ERROR.INVALID_ARGUMENT,[message.destinationName,"Message.destinationName"]));client.send(message)}else message=new Message(payload),message.destinationName=topic,arguments.length>=3&&(message.qos=qos),arguments.length>=4&&(message.retained=retained),client.send(message)},this.disconnect=function(){client.disconnect()},this.getTraceLog=function(){return client.getTraceLog()},this.startTrace=function(){client.startTrace()},this.stopTrace=function(){client.stopTrace()},this.isConnected=function(){return client.connected}};Client.prototype={get host(){return this._getHost()},set host(newHost){this._setHost(newHost)},get port(){return this._getPort()},set port(newPort){this._setPort(newPort)},get path(){return this._getPath()},set path(newPath){this._setPath(newPath)},get clientId(){return this._getClientId()},set clientId(newClientId){this._setClientId(newClientId)},get onConnectionLost(){return this._getOnConnectionLost()},set onConnectionLost(newOnConnectionLost){this._setOnConnectionLost(newOnConnectionLost)},get onMessageDelivered(){return this._getOnMessageDelivered()},set onMessageDelivered(newOnMessageDelivered){this._setOnMessageDelivered(newOnMessageDelivered)},get onMessageArrived(){return this._getOnMessageArrived()},set onMessageArrived(newOnMessageArrived){this._setOnMessageArrived(newOnMessageArrived)},get trace(){return this._getTrace()},set trace(newTraceFunction){this._setTrace(newTraceFunction)}};var Message=function(newPayload){var payload;if(!("string"==typeof newPayload||newPayload instanceof ArrayBuffer||newPayload instanceof Int8Array||newPayload instanceof Uint8Array||newPayload instanceof Int16Array||newPayload instanceof Uint16Array||newPayload instanceof Int32Array||newPayload instanceof Uint32Array||newPayload instanceof Float32Array||newPayload instanceof Float64Array))throw format(ERROR.INVALID_ARGUMENT,[newPayload,"newPayload"]);payload=newPayload,this._getPayloadString=function(){return"string"==typeof payload?payload:parseUTF8(payload,0,payload.length)},this._getPayloadBytes=function(){if("string"==typeof payload){var buffer=new ArrayBuffer(UTF8Length(payload)),byteStream=new Uint8Array(buffer);return stringToUTF8(payload,byteStream,0),byteStream}return payload};var destinationName=void 0;this._getDestinationName=function(){return destinationName},this._setDestinationName=function(newDestinationName){if("string"!=typeof newDestinationName)throw new Error(format(ERROR.INVALID_ARGUMENT,[newDestinationName,"newDestinationName"]));destinationName=newDestinationName};var qos=0;this._getQos=function(){return qos},this._setQos=function(newQos){if(0!==newQos&&1!==newQos&&2!==newQos)throw new Error("Invalid argument:"+newQos);qos=newQos};var retained=!1;this._getRetained=function(){return retained},this._setRetained=function(newRetained){if("boolean"!=typeof newRetained)throw new Error(format(ERROR.INVALID_ARGUMENT,[newRetained,"newRetained"]));retained=newRetained};var duplicate=!1;this._getDuplicate=function(){return duplicate},this._setDuplicate=function(newDuplicate){duplicate=newDuplicate}};return Message.prototype={get payloadString(){return this._getPayloadString()},get payloadBytes(){return this._getPayloadBytes()},get destinationName(){return this._getDestinationName()},set destinationName(newDestinationName){this._setDestinationName(newDestinationName)},get qos(){return this._getQos()},set qos(newQos){this._setQos(newQos)},get retained(){return this._getRetained()},set retained(newRetained){this._setRetained(newRetained)},get duplicate(){return this._getDuplicate()},set duplicate(newDuplicate){this._setDuplicate(newDuplicate)}},{Client:Client,Message:Message}}(window);var instamsg=instamsg||{};instamsg.InstaMsg=function(clientId,authKey,connectHandler,disConnectHandler,oneToOneMessageHandler,options){if(null===clientId||void 0===clientId)throw console.log("You must pass your client id when you instantiate InstaMsg."),new Error("You must pass your client id when you instantiate InstaMsg.");if(null===authKey||void 0===authKey)throw console.log("You must pass your auth key when you instantiate InstaMsg."),new Error("You must pass your auth key when you instantiate InstaMsg.");options=options||{},options.clientId=clientId.substring(0,23),options.userName=clientId.substring(24,36),options.password=authKey;var logLevel=options.logLevel||!1;instamsg.version="beta",instamsg.handlersMap={},instamsg.replyHandlerMap={},instamsg.fileHandlers=[],instamsg.sendMsgHandlers=[],instamsg.resultHandler=[];var filesTopic="instamsg/clients/"+clientId+"/files",enableServerLogging=void 0==options.enableServerLogging?!0:options.enableServerLogging,enableServerLoggingTopic="instamsg/clients/"+clientId+"/enableServerLogging",logToServer=!1,serverLogsTopic="",sendMsgReplyTopic=clientId,onMessageArrived=function(msg){var topic=msg._getDestinationName();if(null===topic||void 0===topic)throw new Error("Invalid topic");switch(logLevel&&(console.log("message Arrived : "+msg.payloadString),console.log("topic is : "+topic)),topic){case enableServerLoggingTopic:if(enableServerLogging){console.log("yes i am called true"),logToServer=!0;var id=msg.payloadString.split("-");if(5!=id.length)throw new Error("Invalid CLient id "+msg.payloadString);serverLogsTopic="instamsg/clients/"+msg.payloadString+"/logs"}else console.log("Server Logging is disabled");break;case filesTopic:try{var json=JSON.parse(msg.payloadString);if(!instamsg.fileHandlers[topic])throw new Error("No Handler is register for "+topic);var message=new instamsg.Message(json.body,{id:json.message_id,topic:json.topic,replyTopic:json.reply_to});instamsg.fileHandlers[topic](message)}catch(e){logLevel&&console.log(e)}break;case sendMsgReplyTopic:try{var json=JSON.parse(msg.payloadString),responseId=(json.message_id,json.response_id);if(responseId){if(instamsg.handlersMap[responseId]){var message=new instamsg.Message(json.body,{id:json.message_id,topic:json.topic,replyTopic:json.reply_to});instamsg.replyHandlerMap[responseId](message)}}else if(oneToOneMessageHandler){var message=new instamsg.Message(json.body,{id:json.message_id,topic:json.topic,replyTopic:json.reply_to});oneToOneMessageHandler(message)}}catch(e){instamsg.handlersMap[topic]&&instamsg.handlersMap[topic](new instamsg.Message(msg.payloadString))}break;default:try{if(!instamsg.handlersMap[topic])throw new Error("No Handler is register for "+topic);instamsg.handlersMap[topic](new instamsg.Message(msg.payloadString,{topic:topic}))}catch(e){logLevel&&console.log(e.message)}}},netError=!1,closeHandler=function(object){try{object.hasOwnProperty("errorCode")&&0!=object.errorCode?(netError=!0,connection.connect()):disConnectHandler(object)}catch(e){logToServer&&console.log(e)}},i=1,onOpenHandler=function(obj){i+=1,i>10&&(i=0),netError?(logLevel&&console.log("Disconnected, Trying to reconnect."),setTimeout(function(){connection.connect()},1e4*i)):connectHandler(obj)},connection=instamsg.ConnectionFactory(onOpenHandler,onMessageArrived,closeHandler,options);connection.connect();var publishServerLogs=function(message){var id=UUIDjs.create(4).toString();connection.publish(id,serverLogsTopic,message,0,0,onPublish,100)},onPublish=function(msg){msg.payload=msg._getPayloadString(),msg._getDestinationName()!=serverLogsTopic&&(logToServer&&publishServerLogs("message published : "+JSON.stringify(msg)),logLevel&&console.log("message published : "+JSON.stringify(msg)),instamsg.resultHandler[msg.id]&&instamsg.resultHandler[msg.id](instamsg.Result.init(msg,!0)),delete instamsg.resultHandler[msg.id])},onSubscribeSuccess=function(subscriptionobj){instamsg.handlersMap[subscriptionobj.invocationContext.topic]=subscriptionobj.invocationContext.msgHandler;var result="Client Subscribe to "+subscriptionobj.invocationContext.topic;logToServer&&publishServerLogs(result),logLevel&&console.log(result),subscriptionobj.invocationContext.resultHandler(instamsg.Result.init(result,!0))},onSubscribeFailure=function(subscriptionobj){var result="Client unable to Subscribe to "+subscriptionobj.invocationContext.topic;logToServer&&publishServerLogs(result),logLevel&&console.log(result),subscriptionobj.invocationContext.resultHandler(instamsg.Result.init(subscriptionobj,!1))},onUnsubscribeSuccess=function(object){delete instamsg.handlersMap[object.invocationContext.topic];var result="Client unsubscribe from "+object.invocationContext.topic;logToServer&&publishServerLogs(result),logLevel&&console.log(result),object.invocationContext.resultHandler(instamsg.Result.init(result,!0))},onUnsubscribeFailure=function(object){var result="Not able to unsubscribe to "+object.invocationContext.topic;logToServer&&publishServerLogs(result),logLevel&&console.log(result),object.invocationContext.resultHandler(instamsg.Result.init(object,!1))};return instamsg.subscribe=function(topic,qos,msgHandler,resultHandler,timeout){if(topic.length<1)throw logToServer&&publishServerLogs("Topic cannot be empty"),logLevel&&console.log("Topic cannot be empty"),new Error("Topic cannot be empty ");void 0!==instamsg.handlersMap[topic]&&(logToServer&&publishServerLogs("Topic cannot be empty"),logLevel&&console.log("You are already subscribed to "+topic));var subscriptionobj={};subscriptionobj.topic=topic,subscriptionobj.msgHandler=msgHandler,subscriptionobj.resultHandler=resultHandler,connection.subscribe(topic,subscriptionobj,qos,onSubscribeSuccess,onSubscribeFailure)},instamsg.unsubscribe=function(topic,msgHandler){void 0===instamsg.handlersMap[topic]&&(logToServer&&publishServerLogs("You are not subscribed to "+topic),logLevel&&console.log("You are not subscribed to "+topic)),connection.unsubscribe(topic,{topic:topic,resultHandler:msgHandler},onUnsubscribeSuccess,onUnsubscribeFailure)},instamsg.close=function(){connection.close()},instamsg.publish=function(topic,message,qos,dup,resultHandler,timeout){var id=UUIDjs.create(4).toString();instamsg.resultHandler[id]=resultHandler,connection.publish(id,topic,message,qos,dup,onPublish,timeout)},instamsg.send=function(clientId,msg,qos,replyHandler,timeout){var messageId=UUIDjs.create(4).toString();instamsg.replyHandlerMap[messageId]=replyHandler;var message={message_id:messageId,topic:clientId,reply_to:sendMsgReplyTopic,body:msg,status:1};logToServer&&publishServerLogs("sending one to one message "+JSON.stringify(message)),logLevel&&console.log("sending one to one message "+JSON.stringify(message)),connection.send(clientId,message,qos,replyHandler,timeout)},instamsg.setFileReceiveHander=function(resultHandler,timeout){},instamsg.deleteFile=function(clientId,fileName,resultHandler,timeout){var messageId=UUIDjs.create(4).toString();instamsg.fileHandlers[messageId]=resultHandler;var message={messageId:messageId,replyTo:filesTopic,method:"DELETE",filename:fileName};connection.send("instamsg/clients/"+clientId+"/files",message,1,timeout)},instamsg.reply=function(content,msg,qos,replyHandler,timeout){instamsg.replyHandlerMap[msg.id()]||(instamsg.replyHandlerMap[msg.id()]=replyHandler);var message={message_id:msg.id(),response_id:msg.id(),topic:msg.replyTopic(),reply_to:msg.topic(),body:content,status:1};logLevel&&console.log("sending reply message "+JSON.stringify(message)),logToServer&&publishServerLogs("sending reply message "+JSON.stringify(message)),connection.send(msg.replyTopic(),message,qos,replyHandler,timeout)},instamsg};var MEDIA_MESSAGE_TYPE={ERROR:"0",CALL:"1",CALL_REPLY:"2",CALL_STOP:"3",CALL_INCOMING:"4",CALL_INCOMING_REPLY:"5",CALL_INCOMING_START:"6",BROADCAST:"7",BROADCAST_REPLY:"8",SUBSCRIBE:"9",SUBSCRIBE_REPLY:"10",RECORDING_PLAY:"11",RECORDING_PLAY_REPLY:"12",RECORDING_PLAY_STOP:"13",RECORDING_PLAY_END:"14",ICE_CANDIDATE:"15",ICE_CANDIDATE_REPLY:"16"},instamsg=instamsg||{};instamsg.InstaMedia=function(from,authKey,connectHandler){var video,webRtcPeer,instaMsg,streamId,to=from,mediaReplyTopic="instamsg/clients/"+from+"/mediareply",mediaSendTopic,mediaStreamsTopic,onSubscribeSuccess=function(result){console.log(result.failed()?"unable to subscribe ":"subscribed to topic "+mediaReplyTopic)},handler=function(msg){var responseMessage=msg.body();console.log("Reply msg received : "+responseMessage);var parsedMessage=eval("("+responseMessage+")");switch(console.log("msg type is : "+parsedMessage.type),parsedMessage.type){case MEDIA_MESSAGE_TYPE.BROADCAST_REPLY:presenterResponse(parsedMessage);break;case MEDIA_MESSAGE_TYPE.SUBSCRIBE_REPLY:viewerResponse(parsedMessage);break;case MEDIA_MESSAGE_TYPE.ICE_CANDIDATE_REPLY:candidate=JSON.parse(parsedMessage.candidate),webRtcPeer.addIceCandidate(candidate,function(error){return error?console.error("Error adding candidate: "+error):void 0});break;case MEDIA_MESSAGE_TYPE.CALL_STOP:dispose();break;default:console.error("Unrecognized message",parsedMessage)}},streamHandler=function(msg){var responseMessage=msg.body();console.log("Media streams msg received : "+responseMessage);var parsedMessage=eval("("+responseMessage+")");console.log(parsedMessage);var messageId=parsedMessage.message_id,replyTo=parsedMessage.reply_to;if(replyTo){var message={response_id:messageId,status:1,streams:streamId};sendInstaMessage(message,replyTo)}};void 0==connectHandler&&(connectHandler=function(result){result.failed()?console.log("InstaMsg not able to connect."):(console.log("InstaMsg socket connected."),instamsg.handlersMap[mediaReplyTopic]=handler)});var viewerConnectHandler=function(result){console.log(result.failed()?"InstaMsg not able to connect.":"InstaMsg socket connected.")},disConnectHandler=function(result){console.log("Connection lost with InstaMsg.")},resultHandler=function(obj){var json=JSON.parse(obj.payloadString);console.log("Result message is : "+json)},timeout,replyHandler=function(msg){console.log("Reply message is : "+msg)},oneToOneMessageHandler=function(msg){console.log("One to one Media streams msg received : "+msg);var replyTo=msg.replyTo;if(console.log(replyTo),replyTo){var content={streams:[streamId]};msg.reply(replyTo,content,1)}},options={logLevel:!0,enableSsl:!1};instaMsg=instamsg.InstaMsg(from,authKey,connectHandler,disConnectHandler,oneToOneMessageHandler,options),this.broadcast=function(strmId,elementId){if(streamId=strmId,video=document.getElementById(elementId),console.log(from),mediaStreamsTopic="instamsg/clients/"+from+"/mediastreams",mediaSendTopic="instamsg/clients/"+from+"/media",instamsg.handlersMap[mediaStreamsTopic]=handler,!webRtcPeer){showSpinner(video);var options={localVideo:video,onicecandidate:onIceCandidate};webRtcPeer=new kurentoUtils.WebRtcPeer.WebRtcPeerSendonly(options,function(error){return error?console.error(error):void webRtcPeer.generateOffer(onOfferPresenter)})}},this.view=function(broadcasterId,strmId,elementId){if(to=broadcasterId,mediaSendTopic="instamsg/clients/"+broadcasterId+"/media",streamId=strmId,video=document.getElementById(elementId),!webRtcPeer){showSpinner(video);var options={remoteVideo:video,onicecandidate:onIceCandidate};webRtcPeer=new kurentoUtils.WebRtcPeer.WebRtcPeerRecvonly(options,function(error){return error?console.error(error):void this.generateOffer(onOfferViewer)})}},this.stop=function(){var message={type:MEDIA_MESSAGE_TYPE.CALL_STOP,to:to,from:from,stream_id:streamId};sendInstaMessage(message,mediaSendTopic),dispose()},this.send=function(clientId,msg,qos,replyHandler,resultHandler,timeout){instaMsg.send(clientId,msg,qos,replyHandler,resultHandler,timeout)},this.disconnect=function(){instaMsg.close()};var getClientId=function(){return viewerClientId?viewerClientId:ClientId},presenterResponse=function(message){if(0==message.response){var errorMsg=message.message?message.message:"Unknow error";console.log("Call not accepted for the following reason: "+errorMsg),dispose()}else streamId=message.stream_id,webRtcPeer.processAnswer(message.sdp_answer,function(error){return error?console.error(error):void 0})},viewerResponse=function(message){if(0==message.response){var errorMsg=message.message?message.message:"Unknow error";console.log("Call not accepted for the following reason: "+errorMsg),dispose()}else webRtcPeer.processAnswer(message.sdp_answer,function(error){return error?console.error(error):void 0})},onOfferPresenter=function(error,offerSdp){if(console.log("onOfferPresenter"),error)return console.error("Error generating the offer");var message={to:to,sdp_offer:offerSdp,from:from,protocol:"webrtc",type:MEDIA_MESSAGE_TYPE.BROADCAST,stream_id:streamId,record:!0};sendInstaMessage(message,mediaSendTopic)},onOfferViewer=function(error,offerSdp){if(error)return console.error("Error generating the offer");var message={to:to,sdp_offer:offerSdp,from:from,protocol:"webrtc",type:MEDIA_MESSAGE_TYPE.SUBSCRIBE,stream_id:streamId,record:!0};sendInstaMessage(message,mediaSendTopic)},onIceCandidate=function(candidate){console.log("Local candidate"+JSON.stringify(candidate));var message={type:MEDIA_MESSAGE_TYPE.ICE_CANDIDATE,to:to,from:from,stream_id:streamId,candidate:JSON.stringify(candidate)};sendInstaMessage(message,mediaSendTopic)},dispose=function(){webRtcPeer&&(webRtcPeer.dispose(),webRtcPeer=null),hideSpinner(video)},sendInstaMessage=function(message,topic){var jsonMessage=JSON.stringify(message);console.log("Sending message on topic : "+topic+" : "+jsonMessage),instaMsg.publish(topic,jsonMessage,1,0)},showSpinner=function(){for(var i=0;i<arguments.length;i++)arguments[i].poster="./img/transparent-1px.png",arguments[i].style.background='center transparent url("./img/spinner.gif") no-repeat'},hideSpinner=function(){for(var i=0;i<arguments.length;i++)arguments[i].src="",arguments[i].poster="./img/webrtc.png",arguments[i].style.background=""}};var instamsg=instamsg||{};instamsg.Message=function(content,options){var self=this,retained=options.retain||!1,Qos=options.qos,body=content||"",isDup=options.dup||!1,Topic=options.topic,replyTopic=options.replyTopic,id=options.id;self.qos=function(){return Qos},self.retained=function(){return retained},self.id=function(){return id},self.topic=function(){return Topic},self.replyTopic=function(){return replyTopic},self.isDublicate=function(){return isDup},self.body=function(){return body},self.reply=function(msg,dup,replyHandler,timeout){instamsg.reply(msg,self,replyHandler,timeout)},self.error=function(errorCode,errorMsg){},self.toString=function(){return"{ id="+id+", topic="+Topic+", body="+body+", qos="+Qos+", dup="+isDup+", replyTopic="+replyTopic+"}"}},Handler.prototype.Handler=function(result){};var instamsg=instamsg||{};instamsg.ConnectionFactory=function(onOpenHandler,onMessageArrived,onCloseHandler,options){return null===options||void 0===options||void 0===options.sockjs||options.sockjsEnabled!==!0?instamsg.SocketConnection.connection(onOpenHandler,onMessageArrived,onCloseHandler,options):instamsg.SockjsConnection(onOpenHandler,onMessageArrived,onCloseHandler,options)};var serverName=window.location.host,tempIndex=serverName.indexOf(":");-1!=tempIndex&&(serverName=serverName.substring(0,tempIndex)),serverName="device.instamsg.io";var instamsg=instamsg||{};instamsg.SocketConnection=instamsg.SocketConnection||{},instamsg.SocketConnection.connection=function(onOpenHandler,onMsgHandler,onCloseHandler,options){options=options||{};var self=this;instamsg.SocketConnection.host=serverName,instamsg.SocketConnection.httpPort=80,instamsg.SocketConnection.httpsPort=443,instamsg.SocketConnection.port=options.enableSsl?self.httpsPort:self.httpPort,instamsg.SocketConnection.client=new Paho.MQTT.Client(instamsg.SocketConnection.host,Number(instamsg.SocketConnection.port),options.clientId),instamsg.SocketConnection.client.onMessageArrived=onMsgHandler,instamsg.SocketConnection.client.onConnectionLost=onCloseHandler,instamsg.SocketConnection.client.onMessageDelivered,instamsg.SocketConnection.publish=function(id,topic,msg,qos,dup,resultHandler,timeout){if(!instamsg.SocketConnection.client.isConnected())return console.log("InstaMsg socket is not connected."),!1;var message=new Paho.MQTT.Message(msg);message.id=id,message.qos=qos,message.dup=dup,message.retained=!1,message.destinationName=topic,instamsg.SocketConnection.client.onMessageDelivered=resultHandler,instamsg.SocketConnection.client.send(message)},instamsg.SocketConnection.send=function(clientId,msg,qos,resultHandler,timeout){if(console.log("Instamsg socket connection send."),!instamsg.SocketConnection.client.isConnected())return console.log("InstaMsg socket is not connected."),!1;var payload=JSON.stringify(msg),message=new Paho.MQTT.Message(payload);void 0==qos&&(qos=1),message.qos=qos,message.retained=!0,message.destinationName=clientId,console.log("sending "+payload),instamsg.SocketConnection.client.onMessageDelivered=resultHandler,instamsg.SocketConnection.client.send(message)},instamsg.SocketConnection.close=function(){if(!instamsg.SocketConnection.client.isConnected())throw console.log("InstaMsg socket is already disconnected."),new Error("InstaMsg socket is already disconnected.");instamsg.SocketConnection.client.disconnect()},instamsg.SocketConnection.onFail=function(message){console.log("error: "+message.errorMessage)};var onConnect=function(result){onOpenHandler(instamsg.Result.init("Connect to InstaMsg socket.",!0))},onFailure=function(result){onOpenHandler(instamsg.Result.init(result.errorMessage,!1))};instamsg.SocketConnection.subscribe=function(topic,invocationContext,qos,onSubscribeSuccess,onSubscribeFailure,timeout){if(!instamsg.SocketConnection.client.isConnected())throw console.log("InstaMsg socket is not connected."),new Error("InstaMsg socket is not connected.");if(topic.length<1)throw console.log("Topic cannot be empty."),new Error("Topic cannot be empty.");instamsg.SocketConnection.client.subscribe(topic,{invocationContext:invocationContext,qos:qos,onSuccess:onSubscribeSuccess,onFailure:onSubscribeFailure,timeout:timeout?timeout:60})},instamsg.SocketConnection.unsubscribe=function(topic,invocationContext,onUnsubscribeSuccess,onUnsubscribeFailure,timeout){if(!instamsg.SocketConnection.client.isConnected())throw console.log("InstaMsg socket is not connected."),new Error("InstaMsg socket is not connected.");instamsg.SocketConnection.client.unsubscribe(topic,{
invocationContext:invocationContext,onSuccess:onUnsubscribeSuccess,onFailure:onUnsubscribeFailure,timeout:timeout?timeout:100})};var Options={timeout:100,userName:options.userName,password:options.password,keepAliveInterval:options.keepAliveTimer||100,cleanSession:!0,useSSL:options.enableSsl?!0:!1,invocationContext:instamsg,onSuccess:onConnect,onFailure:onFailure,mqttVersion:3};return instamsg.SocketConnection.connect=function(){delete Options.mqttVersionExplicit,instamsg.SocketConnection.client.connect(Options)},instamsg.SocketConnection};var instamsg=instamsg||{};instamsg.SockjsConnection=instamsg.SockjsConnection||{},instamsg.SockjsConnection.connection=function(onOpenHandler,onMsgHandler,onCloseHandler,options){var self=this,options=options||{};instamsg.SockjsConnection.host=serverName,instamsg.SockjsConnection.httpPort=80,instamsg.SockjsConnection.httpsPort=443,instamsg.SockjsConnection.path="/instamsg",instamsg.SockjsConnection.port=options.enabledSsl?self.httpsPort:self.httpPort;var sock=new SockJS(self.host+":"+self.port+"/"+self.path);instamsg.SockjsConnection.onopen=onOpenHandler,instamsg.SockjsConnection.onmessage=onMsgHandler,instamsg.SockjsConnection.onclose=onCloseHandler,instamsg.SockjsConnection.publish=function(topic,msg,qos){if(state!=vertx.EventBus.OPEN)throw new Error("INVALID_STATE_ERR");var message=new Paho.MQTT.Message(msg);message.qos=qos,message.retained=!0,message.destinationName=topic,sock.send(message)},instamsg.SockjsConnection.send=function(clientId,msg,qos,replyHandler,timeout){if(state!=vertx.EventBus.OPEN)throw new Error("INVALID_STATE_ERR");var payload=JSON.stringify(msg),message=new Paho.MQTT.Message(payload);message.qos=qos,message.retained=!0,message.destinationName=topic,sock.send(message)},instamsg.SockjsConnection.close=function(){sock.close(),onCloseHandler()}};var instamsg=instamsg||{};instamsg.Result=instamsg.Result||{},instamsg.Result.init=function(result,succeeded){return instamsg.Result.cause=function(){return succeeded?null:result},instamsg.Result.failed=function(){return succeeded?!1:!0},instamsg.Result.succeeded=function(){return succeeded?!0:!1},instamsg.Result.result=function(){return succeeded?result:null},instamsg.Result};